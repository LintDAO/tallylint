<template>
  <div class="container login-container">
    <div class="description row">
      <div class="col-12 col-md-6">
        <h4 style="margin: 0">Welcome to TallyLint🧾</h4>
        <div class="q-mb-xl">
          <div>
            <span class="text-body1">
              TallyLint is designed to help users of ICPs to count and manage
              their tax information more easily. With TallyLint, users will be
              able to record, track and calculate tax information related to
              their transactions and assets in the IC ecosystem.
            </span>
            <br />
            <span class="text-body1">
              In TallyLint, which is 100% on-chain, users get a decentralised,
              private and secure tax experience.
            </span>
          </div>
          <q-btn
            color="primary"
            class="login-button"
            @click="onLogin()"
            :loading="loading"
            no-caps
          >
            Launch app
          </q-btn>
        </div>
        <div class="logo">
          <img alt="logo" src="@/assets/on-chain.svg" />
        </div>
      </div>
      <div class="col-12 col-md-6">
        <q-img src="@/assets/images/intro.png"></q-img>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { IdentityInfo, initAuth, signIn } from "@/api/auth"
import { setCurrentIdentity } from "@/api/canister_pool"
import { useUserStore } from "@/stores/user"
import { onMounted, ref } from "vue"
import { useRouter } from "vue-router"

const router = useRouter()
const userStore = useUserStore()
onMounted(() => {
  // getOKInfo()
})
// 与 II 认证相关的信息
const signedIn = ref(false) // 是否登录

const loading = ref(false)

const onLogin = async () => {
  const auth = await initAuth()
  loading.value = true
  //TODO 先不使用登录缓存，有点问题
  // if (!auth.info) {
  //检查用户是否已登录，未登录就登录
  signIn(auth.client) // 理论上有链接对象才会进入这个方法
    .then((ii) => {
      signedIn.value = true
      auth.info = ii
      loginSuccess(ii)
    })
    .catch((e) => {
      console.error("e", e)
    })
    .finally(() => {
      loading.value = false
    })
  // } else {
  //   //存在auth.info，说明用户已登录，不需要再登录
  //   loginSuccess(auth.info)
  // }
}

const loginSuccess = (ii: IdentityInfo) => {
  // 保存登录状态到actor，方便调用
  setCurrentIdentity(ii.identity, ii.principal)
  // 保存 principal 到状态
  userStore.setPrincipal(ii.principal).then(() => {
    //直接跳转到应用中，在应用里获取userInfo，加快速度。
    router.push({
      path: "/app",
    })
  })
}
</script>

<style lang="scss" scoped>
.login-container {
  margin-top: 100px;
  margin-bottom: 250px;
  overflow: hidden;
  .description > div {
    position: relative;
  }
  .login-button {
    margin-top: 50px;
  }
  .logo {
    position: absolute;
    bottom: 0;
    left: 0;
  }
  // &::before {
  //   overflow: hidden;
  //   content: "";
  //   position: absolute;
  //   bottom: 0;
  //   left: 50%;
  //   transform: translateX(-50%);
  //   width: 50%; // 你可以根据需要调整大小
  //   height: 200px; // 半圆的高度是圆的半径
  //   background: radial-gradient(circle, #c0d9ff, #f0b9e5);
  //   border-radius: 100px 100px 0 0; // 创建半圆
  //   filter: blur(300px); // 模糊效果
  // }
}
</style>
